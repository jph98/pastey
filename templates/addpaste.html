<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
    <title>private pastebins</title>
    <META NAME="keywords" CONTENT="pastebin, paste bin">
    <META NAME="description" CONTENT="pastey paste bin">

    <script src='/pastey/bower_components/ractive/Ractive.js'></script>
    <script src='/pastey/bower_components/underscore/underscore.js'></script>
    <script src='/pastey/bower_components/jquery/dist/jquery.min.js'></script>

    <link href="/pastey/pastey.css" rel="stylesheet" type="text/css" />
</head>

<body>

    <div id="wrapper">
    <div id="header">
    <a href="/pastey"><img src="pastebin_logo.gif" border="0" alt="Pastey" title="Pastey"></a>
    </div>

    <div id="error"></div>

    <div id="container">       

     <script id='tmpl' type='text/ractive'>

     {{#paste}}
                <div id="content">
                        
                            <p>
                            Welcome to Pastey.  Pastey is a paste bin that allows you to upload source code and share it with other people.
                            </p>
                            <ol>
                            <li>Enter a title, choose the source code type (syntax) and enter your name.</li>
                            <li>To share the pastebin with other people send them the link in the address bar.</li></ol>
                        

                                <table cellpadding="0" cellspacing="0">
                                <tr>
                                    <td class="label">Title <span class="mandatory">*</span></td>
                                    <td class="fieldcontainer">                                        
                                                <input id="title" type="text" name="title" value="Sample code review"/>
                                            <div class="errormessage" style="display: none">
                                                    Please enter a title for your pastebin
                                            </div>
                                    </td>
                                    <td class="label">Your Name <span class="mandatory">*</span></td>
                                    <td class="fieldcontainer">
                                                <input id="name" type="text" name="name" value="Jon"/>

                                            <div class="errormessage"  style="display: none">
                                                    Please enter your name
                                            </div>
                                    </td>
                                    <td class="label" align="right" style="text-align: right;">Language <span class="mandatory">*</span></td>
                                    <td class="fieldcontainer" style="white-space:nowrap; padding-bottom:10px;float:right" align="right">

                                                <select id="language" name="language" on-change="languageChange">
                                                    {{#languages}}
                                                        <option value="{{name}}">{{name}}</option>
                                                    {{/languages}}                                          
                                                </select>

                                            <div class="errormessage"  style="display: none">
                                                    Please select the code language
                                            </div>
                                    </td>
                                </tr>
                                <tr>
                                <td class="label" style="vertical-align: top; padding-top: 7px">
                                Source 
                                <span class="mandatory">*</span>
                                </td>
                                <td colspan="5" class="fieldcontainer">

                                        <div id="editor"></div>
                                            
                                        <div class="errormessage" style="display: none">
                                                Please enter the code to put in the paste bin
                                        </div>
                                </td>
                                </tr>

                        </table>

                        <p>
                            <input type="submit" name="add" id="submitPasteButton" on-click="addPaste" value="Add New Paste"/>
                        </p>
                </div>

        </div>

    	<!-- footer -->
    	<div style="clearboth"></div>

    {{/paste}}

    </script>

    
    </div>

    <script src="/pastey/bower_components/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="/pastey/pasteyeditor.js"></script>

    <script>

        var ractive = new Ractive({
            el: 'container',
            template: '#tmpl',
            data: {
                paste: {}
            },
            debug: true
        });    

        function initialise() {

            request = $.ajax({
                url: "/pastey/languages",
                type: "get"
            });

            request.done(function(msg) {
                 console.log("Done");
                 if (msg.hasOwnProperty('error')) {
                    console.log(msg.error);                    
                    $("#error").html("Error: " + msg.error);
                 } else {
                    ractive.set("languages", eval(msg));

                    var editor = ace.edit("editor");
                    setupEditor(editor);
                    addThemes();
                    changeTheme(editor, ractive.get("paste.theme"));
                 }

            });

            request.fail(function(jqXHR, textStatus) {
                 console.log("Fail ");
                 console.log(JSON.stringify(jqXHR));
                 console.log(textStatus);
            });
        }

        initialise();

        ractive.on('languageChange', function (event) {

            var editor = ace.edit("editor");
            changeLanguage(editor, event.node.value);
        });

        ractive.on('addPaste', function ( event ) {            

            var editor = ace.edit("editor");

            console.log("submitting ajax request");
            request = $.ajax({
                url: '/pastey/pastes',
                type: 'post',
                dataType: 'json',
                data: {
                    "sourcecode": editor.getValue(),
                    "language": $("#language").val(),
                    "theme": $("#theme").val(),
                    "title": $("#title").val(),
                    "name": $("#name").val()
                }
            });

            request.done(function(data) {
                window.location.href = data;
            });

            request.fail(function(jqXHR, textStatus) {
                alert("FAIL: Add paste");  
            });

        });
        
    </script>

</body>

</html>

